name: Solar Soiling Analysis

on: 
  repository_dispatch:
    types: [run_soiling_analysis]
  workflow_dispatch:  # Allow manual trigger
    inputs:
      ha_url: 
        description: 'Home Assistant URL'
        required: true
      ha_token: 
        description: 'Home Assistant Token'
        required: true
      forecast_date:
        description: 'Forecast Date (YYYY-MM-DD)'
        required: true
        default: '2025-12-25'

jobs:
  # ⭐ NEW JOB: Check if day is sunny
  check-sunny-day:
    runs-on: ubuntu-latest
    outputs:
      is_sunny: ${{ steps.sunny_check.outputs.is_sunny }}
    
    steps:
      - name:  Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version:  '3.10'
      
      - name:  Install dependencies (minimal)
        run: |
          pip install requests
      
      - name: Check if day is sunny
        id: sunny_check
        continue-on-error: true
        run: |
          python check_sunny_day.py \
            "${{ github.event.client_payload.ha_url || github.event.inputs.ha_url }}" \
            "${{ github.event.client_payload.ha_token || github.event.inputs.ha_token }}" \
            "${{ github.event.client_payload.forecast_date || github.event.inputs.forecast_date }}"
          
          if [ $? -eq 0 ]; then
            echo "is_sunny=true" >> $GITHUB_OUTPUT
          else
            echo "is_sunny=false" >> $GITHUB_OUTPUT
          fi

  # ⭐ MODIFIED JOB: Only run full analysis if sunny
  run-soiling-analysis:
    runs-on: ubuntu-latest
    needs: check-sunny-day
    if: needs.check-sunny-day.outputs.is_sunny == 'true'  # ⭐ ONLY RUN IF SUNNY
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Run soiling analysis
        run: |
          python Soiling_losses_Version3.py \
            "${{ github. event.client_payload.ha_url || github.event.inputs. ha_url }}" \
            "${{ github.event.client_payload.ha_token || github. event.inputs.ha_token }}" \
            "${{ github. event.client_payload.forecast_date || github.event.inputs. forecast_date }}"
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        with: 
          name: soiling-analysis-results
          path: |
            *. xlsx
            *.png
          retention-days: 30
      
      - name: Notify Home Assistant (Success)
        if: success()
        run: |
          curl -X POST "${{ github.event.client_payload.ha_url }}/api/services/persistent_notification/create" \
            -H "Authorization: Bearer ${{ github.event.client_payload.ha_token }}" \
            -H "Content-Type: application/json" \
            -d '{
              "title": "✅ Soiling Analysis Complete",
              "message": "Analysis completed successfully for ${{ github.event.client_payload.forecast_date }}.  Check artifacts for results.",
              "notification_id": "soiling_analysis_result"
            }'
      
      - name: Notify Home Assistant (Failure)
        if: failure()
        run: |
          curl -X POST "${{ github.event.client_payload. ha_url }}/api/services/persistent_notification/create" \
            -H "Authorization: Bearer ${{ github.event.client_payload.ha_token }}" \
            -H "Content-Type: application/json" \
            -d '{
              "title":  "❌ Soiling Analysis Failed",
              "message": "Analysis failed for ${{ github.event.client_payload.forecast_date }}. Check workflow logs.",
              "notification_id": "soiling_analysis_result"
            }'

  # ⭐ NEW JOB:  Notify if day was cloudy (analysis skipped)
  notify-cloudy-day:
    runs-on: ubuntu-latest
    needs:  check-sunny-day
    if:  needs.check-sunny-day. outputs.is_sunny == 'false'
    
    steps:
      - name: Notify Home Assistant - Cloudy Day
        run: |
          curl -X POST "${{ github.event.client_payload.ha_url || github.event.inputs.ha_url }}/api/services/persistent_notification/create" \
            -H "Authorization: Bearer ${{ github.event.client_payload. ha_token || github.event.inputs.ha_token }}" \
            -H "Content-Type: application/json" \
            -d '{
              "title": "☁️ Cloudy Day - Analysis Skipped",
              "message": "The day ${{ github.event.client_payload.forecast_date || github.event.inputs.forecast_date }} is too cloudy for reliable soiling analysis.  Analysis was skipped.",
              "notification_id": "soiling_analysis_cloudy"
            }'
